# Backend Dockerfile for Development
FROM node:22-alpine

WORKDIR /app

# 安裝依賴
COPY package*.json ./
RUN npm install

# 複製 prisma schema
COPY prisma ./prisma/

# 生成 Prisma Client (使用 SQLite schema)
RUN npx prisma generate

# 複製源代碼
COPY . .

# 暴露端口
EXPOSE 3000

# ==================== 啟動指令說明 ====================
# 使用 `prisma db push` 而不是 `prisma migrate dev`
#
# 原因：
# 1. migrate dev 是互動式命令，會詢問 migration 名稱，不適合 Docker CMD
# 2. db push 會直接同步 schema.prisma 到資料庫，適合開發環境
# 3. 開發環境不需要 migration 歷史記錄
#
# prisma db push vs prisma migrate 的差別：
# ┌─────────────────┬──────────────────┬─────────────────────┐
# │                 │ db push          │ migrate             │
# ├─────────────────┼──────────────────┼─────────────────────┤
# │ 生成 migration  │ ❌ 不生成         │ ✅ 生成 SQL 檔案     │
# │ 歷史記錄        │ ❌ 無             │ ✅ 有版本控制        │
# │ 互動式          │ ❌ 非互動         │ ✅ 需要輸入名稱      │
# │ 適用環境        │ 開發環境         │ 生產環境            │
# │ 速度            │ 快               │ 較慢                │
# └─────────────────┴──────────────────┴─────────────────────┘
#
# --skip-generate: 跳過重新生成 Prisma Client（建置時已生成）
# ======================================================

CMD ["sh", "-c", "npx prisma db push --skip-generate && npm run dev"]
