# 變更請求單 CR-001
# 部署架構優化：Vercel + Zeabur 混合架構

## 基本資訊

| 項目 | 內容 |
|------|------|
| **CR 編號** | CR-001 |
| **提出人** | DevOps Team |
| **提出日期** | 2025-10-19 |
| **優先級** | Medium |
| **狀態** | ✅ 已核准並實施（文件更新完成，待 Phase 5 實際部署） |
| **變更類型** | 技術架構優化 |

---

## 變更描述

### 變更原因

**1. 技術優化需求**

當前部署架構將前端、後端、資料庫都部署在單一 Zeabur 平台上。經過技術評估，發現以下優化空間：

- **前端效能瓶頸**：靜態資源未能充分利用 CDN 邊緣網絡
- **載入速度可優化**：Vercel 專為 React/Vite 應用優化，提供更快的首屏載入
- **CI/CD 體驗**：Vercel 提供 PR 預覽環境，有助於測試和協作

**2. 成本優化需求**

- Zeabur 免費方案有使用限制
- Vercel 前端免費方案更慷慨
- 兩者結合可降低整體成本

**3. 各取所長策略**

- **Vercel 專長**：前端靜態資源服務、全球 CDN
- **Zeabur 專長**：後端 API + 資料庫統一管理、Prisma Migration 自動化

### 變更內容

#### 部署架構調整

**現況 (Before)**:
```
Zeabur Platform
  ├── Frontend (React + Vite)
  ├── Backend (Node.js + Express)
  └── Database (PostgreSQL)
```

**調整後 (After)**:
```
Vercel
  └── Frontend (React + Vite)

Zeabur Platform
  ├── Backend (Node.js + Express)
  └── Database (PostgreSQL)
```

#### 技術實作變更

| 組件 | 原部署平台 | 新部署平台 | 變更說明 |
|------|-----------|-----------|---------|
| **Frontend** | Zeabur | **Vercel** | 利用 Vercel 全球 CDN 與自動優化 |
| **Backend** | Zeabur | Zeabur | 維持不變 |
| **Database** | Zeabur | Zeabur | 維持不變 |

#### 配置變更

**Frontend (Vercel)**:
- 自動檢測 Vite 專案並建置
- 環境變數：`VITE_API_URL` (指向 Zeabur 後端)
- GitHub 自動部署

**Backend (Zeabur)**:
- zbpack.json: `npx prisma migrate deploy && npm start`
- 環境變數：`DATABASE_URL=${POSTGRES_DATABASE_URL}`
- **CORS 配置更新**：允許 Vercel 域名 (`*.vercel.app`)

### 預期效益

#### 1. 效能提升
- ⚡ 前端首屏載入速度提升 **30-50%**
- 🌍 全球用戶訪問速度優化（CDN 邊緣節點）
- 📦 靜態資源自動壓縮與優化

#### 2. 成本降低
- 💰 年度成本從 **$72 降至 $12**（節省 83%）
- 🆓 Vercel 免費方案：100GB 頻寬/月
- 🆓 Zeabur 免費方案：後端 + 資料庫

#### 3. 開發體驗改善
- 🔄 每個 PR 自動生成預覽環境
- ⚡ 更快的部署速度（< 2 分鐘）
- 📊 Vercel Analytics 內建分析

#### 4. 可靠性提升
- 🔒 兩個平台互相備援
- 📈 99.99% SLA 保證（Vercel）
- 🔧 降低單一平台故障風險

---

## 影響分析

### 影響的文件

| 文件 | 版本變更 | 需要更新的章節 | 更新人 | 狀態 |
|------|---------|---------------|--------|------|
| **SDD.md** | v1.3.0 → v1.4.0 | • Section 1.2: 部署架構圖<br>• ADR-008: 技術決策<br>• Section 10.2-10.3: 第三方整合 | DevOps Team | ✅ 已完成 |
| **Project-Roadmap.md** | v1.5.0 → v1.6.0 | • Section 7.2: 部署架構<br>• Section 7.3: CI/CD Pipeline<br>• Section 7.6: 回滾計畫<br>• 決策點 4<br>• 預算分配 | PM Team | ✅ 已完成 |
| **README.md** | - | • Section 8: 部署文件說明<br>• DevOps 閱讀指南<br>• 最新變更記錄 | Tech Team | ✅ 已完成 |
| **Backend-Team-Todolist.md** | - | • Task 5.5: 部署目標更新<br>• CI/CD 配置 | Backend Team | ✅ 已完成 |
| **Change-Log.md** | - | • 新增 CR-001 變更記錄 | PM Team | ✅ 已完成 |

### 影響的團隊

#### DevOps 團隊
**預估工作量**: 4 小時（Phase 5 部署時執行）

- [ ] 在 Vercel 建立前端專案並連接 GitHub
- [ ] 配置 Vercel 環境變數（`VITE_API_URL`）
- [ ] 在 Zeabur 建立後端專案並連接 GitHub
- [ ] 配置 Zeabur 環境變數（`DATABASE_URL=${POSTGRES_DATABASE_URL}`）
- [ ] 部署 PostgreSQL 服務至 Zeabur
- [ ] 測試前後端通訊連接
- [ ] 設置 CI/CD 自動部署流程
- [ ] 準備回滾計畫文檔

#### Backend 團隊
**預估工作量**: 2 小時（Phase 5 部署前）

- [ ] 更新 CORS 配置，允許 Vercel 域名
  ```typescript
  // backend/src/config/cors.ts
  const allowedOrigins = [
    'http://localhost:5173',
    'https://*.vercel.app', // 新增
    process.env.FRONTEND_URL
  ];
  ```
- [ ] 檢查 API 回應格式
- [ ] 準備環境變數文檔
- [ ] 測試 API 端點

#### Frontend 團隊
**預估工作量**: 1 小時

- [ ] 確認前端環境變數配置（`.env.production`）
  ```bash
  VITE_API_URL=https://backend.zeabur.app
  ```
- [ ] 測試 API 串接功能
- [ ] 驗證生產環境建置

#### QA 團隊
**預估工作量**: 3 小時（Phase 5 部署後）

- [ ] 執行 E2E 測試驗證部署
- [ ] 檢查前後端整合功能（CRUD 操作）
- [ ] 驗證 CORS 配置正確性
- [ ] 效能測試（載入速度、API 回應時間）
- [ ] 跨瀏覽器測試

**總工作量**: 10 小時（約 1.5 工作天）

### 時程影響

| 項目 | 原定日期 | 調整後日期 | 延遲天數 |
|------|---------|-----------|---------|
| **MVP 完成日期** | 2025-11-06 | 2025-11-06 | **0 天** |
| **Phase 5 開始** | 2025-11-04 | 2025-11-04 | 0 天 |
| **Phase 5 完成** | 2025-11-06 | 2025-11-06 | 0 天 |

**結論**：✅ **無時程延遲** - 此變更為架構優化，不影響專案時程

### 資源影響

#### 人力需求
- ✅ **無額外人力需求** - 現有團隊可完成

#### 預算影響

| 項目 | 原預算 | 新預算 | 差異 |
|------|--------|--------|------|
| **前端託管** (Vercel Hobby) | $0 | $0 | $0 |
| **後端託管** (Zeabur Free) | $0 | $0 | $0 |
| **資料庫** (包含在 Zeabur) | $60/年 | $0 | **-$60** |
| **域名** | $12/年 | $12/年 | $0 |
| **總計** | **$72/年** | **$12/年** | **-$60/年** |

**結論**：✅ **成本降低 83%**

#### 技術風險

| 風險 | 可能性 | 影響 | 風險等級 | 應對措施 |
|------|-------|------|---------|---------|
| **CORS 配置錯誤導致前後端無法通訊** | 中 | 高 | 🟡 中 | • 詳細文檔記錄配置步驟<br>• Phase 5 部署前充分測試<br>• 準備回滾計畫 |
| **需管理兩個平台增加複雜度** | 低 | 中 | 🟢 低 | • 建立部署檢查清單<br>• 自動化 CI/CD 流程 |
| **Vercel 免費方案流量超限** | 低 | 中 | 🟢 低 | • 監控流量使用情況<br>• 設置預警通知<br>• 升級方案作為備案 |
| **資料遷移問題** | 低 | 低 | 🟢 低 | • 後端與資料庫維持在 Zeabur<br>• 無需資料遷移 |

**整體風險評估**：🟢 **低風險** - 大部分風險都有明確應對措施

---

## 審核紀錄

### 技術審核 (Tech Lead)

- **審核人**: Technical Team
- **審核日期**: 2025-10-19
- **審核結果**: ✅ **通過**

**技術可行性評估**:
- ✅ Vercel 與 Zeabur 技術架構成熟穩定
- ✅ 前後端分離部署符合最佳實踐
- ✅ CORS 配置方案明確可行
- ✅ 現有團隊具備實施能力
- ✅ 風險可控，有完整應對措施

**技術建議**:
- 建議在 Phase 5 部署前進行完整的整合測試
- 建議準備詳細的回滾計畫
- 建議監控前端載入效能改善情況

### 產品審核 (PM)

- **審核人**: Product Team
- **審核日期**: 2025-10-19
- **審核結果**: ✅ **通過**

**商業價值評估**:
- ✅ 成本降低 83%，ROI 明確
- ✅ 效能提升有助於用戶體驗
- ✅ 無時程延遲，不影響 MVP 上線
- ✅ 技術債務減少，長期維護成本降低

**產品建議**:
- 支持此技術優化決策
- 建議在部署後收集用戶體驗數據
- 建議將效能提升作為產品賣點之一

### 最終決策 (Decision Maker)

- **決策人**: Project Lead
- **決策日期**: 2025-10-19
- **決策結果**: ✅ **核准**

**決策理由**:
1. **技術優勢明確** - Vercel 在前端託管領域的專業性
2. **成本效益顯著** - 年度成本降低 83%
3. **風險可控** - 有完整的應對措施和回滾計畫
4. **無時程影響** - 不影響 MVP 上線目標
5. **團隊能力充足** - 現有團隊可完成實施

**執行要求**:
- 按照實施計畫逐步執行
- 保持文檔更新
- 部署前充分測試
- 部署後監控效能

---

## 實施計畫

### Phase 1: 文件更新（2025-10-19）✅ 已完成

- [x] 更新 SDD.md v1.4.0
- [x] 更新 Project-Roadmap.md v1.6.0
- [x] 更新 README.md
- [x] 更新 Backend-Team-Todolist.md
- [x] 建立 CR-001 文件
- [x] 更新 Change-Log.md
- [x] 通知各團隊（透過 Change-Log）

### Phase 2: 技術準備（Phase 5 部署前）⏳ 待執行

**Backend 團隊**:
- [ ] 更新 CORS 配置
- [ ] 準備環境變數文檔
- [ ] 測試 API 端點

**Frontend 團隊**:
- [ ] 設置生產環境變數
- [ ] 驗證建置流程

**DevOps 團隊**:
- [ ] 準備 Vercel 專案設定
- [ ] 準備 Zeabur 專案設定
- [ ] 準備部署檢查清單

### Phase 3: 部署執行（2025-11-04 - 2025-11-06）⏳ 待執行

**Day 1: 2025-11-04**
- [ ] 建立 Vercel 專案
- [ ] 建立 Zeabur 專案
- [ ] 部署 PostgreSQL 服務
- [ ] 配置環境變數

**Day 2: 2025-11-05**
- [ ] 部署後端至 Zeabur
- [ ] 執行資料庫 Migration
- [ ] 部署前端至 Vercel
- [ ] 測試前後端連接

**Day 3: 2025-11-06**
- [ ] E2E 測試
- [ ] 效能測試
- [ ] 問題修復
- [ ] 正式上線

### Phase 4: 驗證與監控（2025-11-07 起）⏳ 待執行

- [ ] 收集效能數據（載入速度、API 回應時間）
- [ ] 監控錯誤日誌
- [ ] 收集用戶反饋
- [ ] 評估成本實際支出
- [ ] 撰寫部署後報告

---

## 相關文件

### 技術文檔
- `docs/02-design/SDD.md` - Section 1.2 部署架構圖
- `docs/02-design/SDD.md` - ADR-008 技術決策記錄
- `docs/04-execution/devops/Zeabur CLI.md` - Zeabur 工具使用指南
- `docs/02-design/Database-Migration-Guide.md` - 資料庫遷移說明

### 規劃文檔
- `docs/03-planning/Project-Roadmap.md` - Section 7.2, 7.3, 7.6
- `docs/04-execution/backend/Backend-Team-Todolist.md` - Task 5.5

### 變更管理
- `docs/05-change-management/Change-Log.md` - 2025-10-19 變更記錄

---

## 附錄

### A. CORS 配置範例

```typescript
// backend/src/config/cors.ts
import type { CorsOptions } from 'cors';

const allowedOrigins = [
  'http://localhost:5173',           // 本地開發
  'https://*.vercel.app',             // Vercel 預覽/生產
  process.env.FRONTEND_URL            // 自訂域名
].filter(Boolean);

export const corsOptions: CorsOptions = {
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.some(pattern =>
      new RegExp(pattern.replace('*', '.*')).test(origin)
    )) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
};
```

### B. 環境變數配置

**Vercel (Frontend)**:
```bash
# .env.production
VITE_API_URL=https://your-backend.zeabur.app
```

**Zeabur (Backend)**:
```bash
# Environment Variables
DATABASE_URL=${POSTGRES_DATABASE_URL}
NODE_ENV=production
PORT=3000
FRONTEND_URL=https://your-frontend.vercel.app
```

### C. 部署檢查清單

**部署前檢查**:
- [ ] 所有測試通過
- [ ] CORS 配置已更新
- [ ] 環境變數已設置
- [ ] 資料庫 Migration 已準備

**部署後檢查**:
- [ ] 前端可訪問
- [ ] 後端 API 正常
- [ ] 資料庫連接正常
- [ ] CORS 無錯誤
- [ ] E2E 測試通過

---

**文件狀態**: ✅ 已核准並實施（文件更新完成）
**最後更新**: 2025-10-19
**下次審查**: 2025-11-07（部署後檢討）
