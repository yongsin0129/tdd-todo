# 變更請求單 CR-002
# 新增 Todo 優先級（Priority）功能

## 基本資訊

| 項目 | 內容 |
|------|------|
| **CR 編號** | CR-002 |
| **提出人** | Product Team |
| **提出日期** | 2025-10-24 |
| **優先級** | Medium |
| **狀態** | ⏳ 待審核 |
| **變更類型** | 功能新增 |

---

## 變更描述

### 變更原因

**1. 產品需求優化**

根據 `docs/01-requirements/PRD.md` 第 7.2 節（Phase 2 - Should Have 功能），優先級設定功能原本就在產品規劃中：

```markdown
#### 功能 7: 優先級設定
- 設定任務優先級（低/中/高）
- 按優先級排序
```

**2. 用戶實際需求**

- **任務管理效率提升**：用戶需要快速識別哪些任務最重要
- **時間管理優化**：根據優先級合理安排工作順序
- **視覺化優先順序**：清楚看到任務的輕重緩急

**3. 競品分析驅動**

根據 PRD 競品分析，主要競品（Todoist, Microsoft To Do）都提供優先級功能，這是待辦事項應用的標準配備。

### 變更內容

#### 功能規格

**功能名稱**：Todo 優先級（Priority）標籤

**核心特性**：
- ✅ 四級優先級分類（緊急/高/中/低）
- ✅ 自動優先級排序
- ✅ 組合篩選功能（優先級 + 完成狀態）
- ✅ 可編輯優先級
- ✅ 舊資料向下相容

#### 詳細規格

**1. 優先級分類系統**

| 層級 | 中文 | 英文（資料庫） | 排序權重 | 建議使用場景 |
|:----:|:----:|:-------------:|:-------:|------------|
| 1 | 緊急 | `CRITICAL` | 1 | 必須立即處理的緊急事項 |
| 2 | 高 | `HIGH` | 2 | 重要且需優先處理的任務 |
| 3 | 中 | `NORMAL` | 3 | 普通重要度的常規任務 |
| 4 | 低 | `LOW` | 4 | 可延後處理的次要任務 |

**2. 欄位設計**

```typescript
interface Todo {
  id: string;
  title: string;
  isCompleted: boolean;
  priority: 'CRITICAL' | 'HIGH' | 'NORMAL' | 'LOW';  // 新增欄位
  createdAt: Date;
  updatedAt: Date;
  completedAt: Date | null;
}
```

**3. 資料庫 Schema 變更**

```prisma
model Todo {
  id          String   @id @default(uuid())
  title       String
  isCompleted Boolean  @default(false)
  priority    String   @default("LOW")  // 新增欄位，預設為 LOW
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
}
```

**4. 排序邏輯**

```typescript
// 排序優先級：完成狀態 > 優先級 > 建立時間
const sortTodos = (todos: Todo[]) => {
  return todos.sort((a, b) => {
    // 第一層：未完成在前
    if (a.isCompleted !== b.isCompleted) {
      return a.isCompleted ? 1 : -1;
    }

    // 第二層：優先級排序
    const priorityOrder = { CRITICAL: 1, HIGH: 2, NORMAL: 3, LOW: 4 };
    if (a.priority !== b.priority) {
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    }

    // 第三層：建立時間（新的在前）
    return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
  });
};
```

**5. 篩選功能**

```typescript
interface FilterOptions {
  priority?: 'CRITICAL' | 'HIGH' | 'NORMAL' | 'LOW' | null;
  isCompleted?: boolean | null;
}

// 範例：篩選未完成的緊急任務
filterTodos({ priority: 'CRITICAL', isCompleted: false });
```

**6. UI/UX 設計**

**新增 Todo 表單**：
```
┌─────────────────────────────────────┐
│ What needs to be done?              │
│ ┌─────────────────────────────────┐ │
│ │ [輸入待辦事項...]                │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 優先級： ○ 緊急 ○ 高 ● 中 ○ 低     │  ← 新增選項（預設：低）
│                                     │
│ [Add Todo]                          │
└─────────────────────────────────────┘
```

**Todo 清單顯示**：
```
篩選： [全部 ▼] [優先級 ▼] [狀態 ▼]     ← 新增篩選器

☐ [🔴 緊急] 修復生產環境 Bug           ← 視覺標示
☐ [🟠 高] 完成專案報告
☐ [🟡 中] 回覆客戶郵件
☐ [🟢 低] 整理桌面
──────────────────────────────────
☑ [🔴 緊急] 處理緊急客訴
☑ [🟡 中] 準備會議資料
```

**編輯模式**：
```
┌─────────────────────────────────────┐
│ ✏️ 編輯中...                        │
│ ┌─────────────────────────────────┐ │
│ │ 修復生產環境 Bug                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 優先級： ● 緊急 ○ 高 ○ 中 ○ 低     │  ← 可修改
│                                     │
│ [儲存 (Enter)] [取消 (Esc)]         │
└─────────────────────────────────────┘
```

### 預期效益

#### 1. 用戶體驗提升
- ⚡ **任務識別更快速**：一眼就能看出哪些任務最重要
- 🎯 **工作效率提升**：優先處理高優先級任務，提高生產力
- 📊 **任務管理更清晰**：透過優先級和篩選快速找到目標任務

#### 2. 產品競爭力
- 🏆 **功能完整度**：補足與競品的功能差距
- 👥 **用戶留存率**：提供更完整的任務管理體驗，降低流失率
- 📈 **市場定位**：從"簡潔工具"升級為"功能完整但簡潔"的產品

#### 3. 技術架構優化
- 🔧 **可擴展性**：為未來功能（如截止日期、分類）奠定基礎
- 📦 **資料完整性**：更豐富的資料維度，支援未來分析需求

---

## 影響分析

### 影響的文件

| 文件 | 版本變更 | 需要更新的章節 | 更新人 | 狀態 |
|------|---------|---------------|--------|------|
| **PRD.md** | 維持 v1.0.0 | 無需更新（功能已在原規劃中） | - | ✅ 無需更新 |
| **SDD.md** | v1.4.0 → v1.5.0 | • Section 6: 資料模型（新增 priority 欄位）<br>• Section 3: 系統流程圖（更新排序邏輯）<br>• 新增 ADR-009: 優先級設計決策 | Tech Team | ⏳ 待更新 |
| **API-Specification.md** | 需更新 | • POST /api/todos（新增 priority 參數）<br>• PUT /api/todos/:id（新增 priority 參數）<br>• GET /api/todos（新增 priority 查詢參數） | Backend Team | ⏳ 待更新 |
| **Database-Design.md** | v1.1.0 → v1.2.0 | • Section 2: 資料表結構（新增 priority 欄位）<br>• Section 6: 資料庫遷移（新增遷移腳本） | Backend Team | ⏳ 待更新 |
| **Project-Roadmap.md** | v1.7.0 → v1.8.0 | • 啟動 Phase 6.1<br>• 新增優先級功能任務 | PM Team | ⏳ 待更新 |
| **Backend-Team-Todolist.md** | v1.1.0 → v1.2.0 | • 新增 Phase 6.1 後端開發任務 | Backend Team | ⏳ 待更新 |
| **Frontend-Team-Todolist.md** | 需更新 | • 新增 Phase 6.1 前端開發任務 | Frontend Team | ⏳ 待更新 |
| **Change-Log.md** | 需更新 | • 新增 CR-002 變更記錄 | PM Team | ⏳ 待更新 |

### 影響的團隊

#### Backend 團隊
**預估工作量**: 2 天（16 小時）

**任務清單**：
- [ ] 更新 Prisma Schema（新增 priority 欄位）
- [ ] 撰寫資料庫遷移腳本（設定舊資料 priority = 'LOW'）
- [ ] 更新 API 端點（POST/PUT 新增 priority 參數）
- [ ] 新增優先級驗證邏輯（只允許 CRITICAL/HIGH/NORMAL/LOW）
- [ ] 更新 GET /api/todos 排序邏輯（按優先級排序）
- [ ] 新增優先級篩選功能（查詢參數）
- [ ] 撰寫單元測試（priority 驗證、排序邏輯）
- [ ] 撰寫整合測試（API 端點測試）
- [ ] 更新 API 文件

**技術風險**：
- 🟡 資料庫遷移需確保舊資料正確更新
- 🟢 API 變更向下相容（priority 為選填，有預設值）

#### Frontend 團隊
**預估工作量**: 2.5 天（20 小時）

**任務清單**：
- [ ] 新增 Priority 選擇組件（Radio Buttons）
- [ ] 更新 TodoForm 組件（整合優先級選擇）
- [ ] 更新 TodoItem 組件（顯示優先級標籤）
- [ ] 更新編輯模式（支援優先級修改）
- [ ] 實作優先級排序邏輯（客戶端排序）
- [ ] 實作篩選功能（優先級 + 完成狀態組合篩選）
- [ ] 設計優先級視覺樣式（顏色、圖標）
- [ ] 撰寫組件測試（Priority 組件、篩選邏輯）
- [ ] 撰寫 E2E 測試（新增、編輯、篩選流程）
- [ ] 響應式設計調整（手機版優先級顯示）
- [ ] 無障礙設計（鍵盤操作、螢幕閱讀器）

**技術風險**：
- 🟡 UI 空間限制（需設計緊湊的優先級顯示方式）
- 🟢 效能影響（排序和篩選對大量 Todo 的影響）

#### QA 團隊
**預估工作量**: 1 天（8 小時）

**任務清單**：
- [ ] 測試優先級新增功能（預設值、四種優先級）
- [ ] 測試優先級編輯功能
- [ ] 測試排序邏輯（多種組合）
- [ ] 測試篩選功能（單一篩選、組合篩選）
- [ ] 測試資料遷移（舊資料是否正確設定）
- [ ] 跨瀏覽器測試
- [ ] 行動裝置測試
- [ ] 無障礙測試
- [ ] 效能測試（大量 Todo 排序和篩選）
- [ ] 撰寫測試報告

#### DevOps 團隊
**預估工作量**: 0.5 天（4 小時）

**任務清單**：
- [ ] 執行資料庫遷移（開發環境）
- [ ] 執行資料庫遷移（生產環境）
- [ ] 驗證遷移結果
- [ ] 監控部署後狀態

**總工作量**: **6 工作天**（48 小時）

### 時程影響

| 項目 | 原定日期 | 調整後日期 | 延遲天數 |
|------|---------|-----------|---------|
| **Phase 6.1 開始** | TBD | 2025-10-25 | - |
| **Phase 6.1 完成** | TBD | 2025-11-01 | - |
| **Phase 6 其他功能** | TBD | 順延 | 不影響 MVP |

**結論**：✅ **不影響 MVP 上線**，此為 Phase 6 擴展功能

### 資源影響

#### 人力需求
- ✅ **無額外人力需求** - 現有團隊可完成

#### 預算影響

| 項目 | 原預算 | 新預算 | 差異 |
|------|--------|--------|------|
| **開發成本** | - | 0 | $0 |
| **基礎設施** | $12/年 | $12/年 | $0 |

**結論**：✅ **無預算影響**

#### 技術風險

| 風險 | 可能性 | 影響 | 風險等級 | 應對措施 |
|------|-------|------|---------|---------|
| **資料庫遷移失敗** | 低 | 高 | 🟡 中 | • 充分測試遷移腳本<br>• 備份生產資料庫<br>• 準備回滾計畫 |
| **排序邏輯效能問題** | 低 | 中 | 🟢 低 | • 效能測試（1000+ Todo）<br>• 前端分頁或虛擬列表 |
| **UI 空間不足** | 中 | 低 | 🟢 低 | • 設計緊湊的 Priority 顯示<br>• 手機版可折疊顯示 |
| **舊資料預設值不符期望** | 低 | 低 | 🟢 低 | • 允許用戶批量編輯優先級<br>• 提供遷移通知 |

**整體風險評估**：🟢 **低風險** - 大部分風險都有明確應對措施

---

## 審核紀錄

### 技術審核 (Tech Lead)

- **審核人**: Technical Team
- **審核日期**: 待審核
- **審核結果**: ⏳ 待審核

**技術可行性評估**:
- ⏳ 待評估

### 產品審核 (PM)

- **審核人**: Product Team
- **審核日期**: 待審核
- **審核結果**: ⏳ 待審核

**商業價值評估**:
- ⏳ 待評估

### 最終決策 (Decision Maker)

- **決策人**: Project Lead
- **決策日期**: 待決策
- **決策結果**: ⏳ 待決策

---

## 實施計畫

### Phase 1: 設計與規劃（1 天）

**Day 1: 2025-10-25**
- [ ] CR-002 審核與核准
- [ ] 更新所有相關文件（SDD、API、Database、Roadmap）
- [ ] 技術設計會議（前後端對齊 API 格式）
- [ ] UI/UX 設計確認（優先級視覺樣式）
- [ ] 測試策略規劃

### Phase 2: 後端開發（2 天）

**Day 2-3: 2025-10-26 ~ 2025-10-27**
- [ ] 更新 Prisma Schema
- [ ] 撰寫資料庫遷移腳本
- [ ] 執行開發環境遷移
- [ ] 更新 API 端點（POST/PUT/GET）
- [ ] 新增優先級驗證
- [ ] 撰寫單元測試與整合測試
- [ ] API 文件更新
- [ ] Code Review

### Phase 3: 前端開發（2.5 天）

**Day 3-5: 2025-10-27 ~ 2025-10-29**
- [ ] 開發 Priority 選擇組件
- [ ] 更新 TodoForm 組件
- [ ] 更新 TodoItem 組件
- [ ] 實作排序邏輯
- [ ] 實作篩選功能
- [ ] 視覺樣式設計
- [ ] 撰寫組件測試
- [ ] 響應式設計調整
- [ ] 無障礙設計實作
- [ ] Code Review

### Phase 4: 整合測試（1 天）

**Day 6: 2025-10-30**
- [ ] 前後端整合測試
- [ ] E2E 測試
- [ ] 跨瀏覽器測試
- [ ] 行動裝置測試
- [ ] 效能測試
- [ ] 無障礙測試
- [ ] Bug 修復

### Phase 5: 部署（0.5 天）

**Day 7: 2025-11-01**
- [ ] 部署至 Staging 環境
- [ ] 執行生產環境資料庫遷移
- [ ] 驗證遷移結果
- [ ] 部署至生產環境
- [ ] 監控與驗證
- [ ] 完成部署檢查清單

---

## 相關文件

### 需求文檔
- `docs/01-requirements/PRD.md` - Section 7.2 (功能優先級)

### 技術文檔
- `docs/02-design/SDD.md` - 待更新
- `docs/02-design/API-Specification.md` - 待更新
- `docs/02-design/Database-Design.md` - 待更新

### 規劃文檔
- `docs/03-planning/Project-Roadmap.md` - 待更新 Phase 6.1

### 執行文檔
- `docs/04-execution/backend/Backend-Team-Todolist.md` - 待更新
- `docs/04-execution/frontend/Frontend-Team-Todolist.md` - 待更新

### 變更管理
- `docs/05-change-management/Change-Log.md` - 待更新

---

## 附錄

### A. 資料庫遷移腳本範例

```sql
-- 新增 priority 欄位
ALTER TABLE "Todo" ADD COLUMN "priority" TEXT NOT NULL DEFAULT 'LOW';

-- 為舊資料設定預設優先級
UPDATE "Todo" SET "priority" = 'LOW' WHERE "priority" IS NULL;

-- 新增 CHECK 約束（確保只允許四種優先級）
ALTER TABLE "Todo" ADD CONSTRAINT "priority_check"
  CHECK ("priority" IN ('CRITICAL', 'HIGH', 'NORMAL', 'LOW'));
```

### B. API 請求/回應範例

**POST /api/todos - 新增 Todo**
```json
// Request
{
  "title": "修復生產環境 Bug",
  "priority": "CRITICAL"
}

// Response
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "修復生產環境 Bug",
  "isCompleted": false,
  "priority": "CRITICAL",
  "createdAt": "2025-10-24T10:30:00Z",
  "updatedAt": "2025-10-24T10:30:00Z",
  "completedAt": null
}
```

**PUT /api/todos/:id - 更新優先級**
```json
// Request
{
  "title": "修復生產環境 Bug",
  "priority": "HIGH"
}

// Response
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "修復生產環境 Bug",
  "isCompleted": false,
  "priority": "HIGH",
  "createdAt": "2025-10-24T10:30:00Z",
  "updatedAt": "2025-10-24T11:00:00Z",
  "completedAt": null
}
```

**GET /api/todos?priority=CRITICAL - 篩選優先級**
```json
// Response
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "修復生產環境 Bug",
    "isCompleted": false,
    "priority": "CRITICAL",
    "createdAt": "2025-10-24T10:30:00Z",
    "updatedAt": "2025-10-24T11:00:00Z",
    "completedAt": null
  }
]
```

### C. Prisma Schema 範例

```prisma
model Todo {
  id          String   @id @default(uuid())
  title       String
  isCompleted Boolean  @default(false)
  priority    String   @default("LOW")  // 新增欄位
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?

  @@index([priority])           // 新增索引提升查詢效能
  @@index([isCompleted, priority])  // 組合索引
}
```

### D. 優先級視覺設計建議

**顏色方案**：
- 🔴 緊急 (CRITICAL): `#EF4444` (紅色)
- 🟠 高 (HIGH): `#F59E0B` (橙色)
- 🟡 中 (NORMAL): `#10B981` (綠色)
- 🟢 低 (LOW): `#6B7280` (灰色)

**Tailwind CSS 類別**：
```typescript
const priorityStyles = {
  CRITICAL: 'bg-red-100 text-red-800 border-red-300',
  HIGH: 'bg-orange-100 text-orange-800 border-orange-300',
  NORMAL: 'bg-green-100 text-green-800 border-green-300',
  LOW: 'bg-gray-100 text-gray-800 border-gray-300',
};
```

### E. 測試案例範例

**測試案例 1: 新增 Todo 預設優先級**
```typescript
test('新增 Todo 時預設優先級為 LOW', async () => {
  const response = await request(app)
    .post('/api/todos')
    .send({ title: '測試任務' });

  expect(response.body.priority).toBe('LOW');
});
```

**測試案例 2: 優先級排序**
```typescript
test('Todo 清單按優先級排序', async () => {
  // 建立不同優先級的 Todo
  await createTodo({ title: 'A', priority: 'LOW' });
  await createTodo({ title: 'B', priority: 'CRITICAL' });
  await createTodo({ title: 'C', priority: 'HIGH' });

  const response = await request(app).get('/api/todos');

  expect(response.body[0].priority).toBe('CRITICAL');
  expect(response.body[1].priority).toBe('HIGH');
  expect(response.body[2].priority).toBe('LOW');
});
```

**測試案例 3: 優先級篩選**
```typescript
test('篩選緊急任務', async () => {
  await createTodo({ title: 'A', priority: 'CRITICAL' });
  await createTodo({ title: 'B', priority: 'LOW' });

  const response = await request(app)
    .get('/api/todos?priority=CRITICAL');

  expect(response.body).toHaveLength(1);
  expect(response.body[0].title).toBe('A');
});
```

---

**文件狀態**: ⏳ 待審核
**最後更新**: 2025-10-24
**下次審查**: 2025-10-25（審核會議）
